# Exploration 2 Journal

## Link
https://www.ilam56.com/exploration2/

## Basic Description
The project is a basic survey. The user can go to the page and answer 5 different questions on the survey. After the user has filled out the survey he can submit it and be taken to a results page. This page highlights the user's last submitted answers and populates the page such that beside each answer is the count of how many times that answer has been picked. It accomplishes this by use of a MongoDB database accessed though a NodeJS back-end. The database stores all the survey results, and when the view page loads, it counts those results so they can be displayed on the page.

## Node  
First I watched lecture 11 and got a basic node server working. I didn't have much problem with the basics, but had to read up a bit to figure out what everything did. As I will get into later, I did have some problems down the line with things like parsing the incoming data as well as a few other problems. I had a brief issue with a header error until I realized it was because I was calling res.send twice, which is not something you are alowed to do. Later on after I had done most of the exploration I started to run into trouble with asynchronous functions. I wanted to send my response after the functions where done, but wasn't sure how to do that as there were multiple function that I had running in parralell and I had to wait for them each before I could send the response. In the end I found a page that helped my by using the .after of the underscore lib from https://stackoverflow.com/questions/18008479/node-js-wait-for-multiple-async-calls

## MongoDB
At first I had no problems with MongoDB. I followed a few simple tutorials and did some testing and it all worked fine. I mostly looked at the tutorial https://www.digitalocean.com/community/tutorials/how-to-integrate-mongodb-with-your-node-application and https://mongoosejs.com/docs/. My general goal was to create a scheme I could input survey results into. The goal was to be able to input the survey results from a post request, then count the results and send back the counts through a get request. I didn't have too much trouble and was able to set up the Survey schema and model without issue. I was also able to make a function to add a new survey from the post request. There were a few areas that did give me trouble though. I spent of good deal of time trying to figure out how to count the instances of each value in a collection, but kept running into walls. Aggregate seemed like it was what I wanted, but it didn't quite work right. For one I couldn't get the output in the format I wanted, and I couldn't figure out how to aggregate the whole collection. In the end I just decided to call the Model.count() function from mongoose. I built a custom fuction to take in a doc, and a key value and count the appearances of the key value in the doc that seemed to work okay, but still wasn't that effiecient as I had to call it a lot of times. If I was going to extend this project out, I would have created a second schema that just holds the counts and simple do the increments whenever a new survey is created. Other than that problem things went somewhat fine with MongoDB. Many of my problem came from other places such as not having the data formated correctly.

## Communication with the front end
This is where I had the most trouble. To be honest, if I just wanted to get it to work with html, I would have had the project done pretty fast. I wanted to use angular for the front end and that resulted in quite a lot of headache. Angular HTTP seems to work quite differently. I had everything working with my html test page, but when I moved to angular I really had a hard time. First of all angular deals with forms in a completely different way which took a bit of struggle to format correctly. The next problem was trying to figure out how to post in angular. I looked at several guides such as the one at https://www.positronx.io/how-to-use-angular-8-httpclient-to-post-formdata/. However I ran into several problems. At first I had no idea what was going on and spent several hours messing with things trying to fix it. Then by chance I loaded the stackblitz page outside of stackblitz and realized the console gave more detailed errors if loaded on a seperate page. The more detailed error told me I was dealing with a CORS error. Once I knew what was wrong I was able to fix it pretty fast. I just followed a few quick guides such as the one here https://stackoverflow.com/questions/18310394/no-access-control-allow-origin-node-apache-port-issue. I actually did run into a bit of trouble with it because I didn't realize I needed the headers in both node and angular, but once I figure that out and got the right headers in both places it worked. That led me to my next problem. All the form data I sent with the post ended up showing up as a empty object "{}". I tried several different formats. I tried sending it the type FormGroup, FormGroup.value, plain text, and several other things, but nothing worked. I after some searching the web I finally realize that the problem was with node. Node had the parsing for json and xml but not for form data. I hadn't considered this because it was able to recieve it just fine from my test html case. For some reason angular form data gets sent differently. I added the node code to all it to parse form data from this link https://www.tutorialspoint.com/expressjs/expressjs_form_data.htm. After that much of the issue was solved. I did have some minor problems such as getting double submissions when the user spams the submit buttons, but I was able to fix that pretty easily by adding a spamProtect bool which I used to only have the submit run if it hadn't been run or had an error yet.

## Front end
I realize this is an exploration about back end, but I felt I should still breifly explain my front end. I just made a basic survey using reactive forms in angular that post the data to the server then redirects to a view page. The view page then does a get request to get the count of the survey selections and uses the results to populate an html page that looks similar to the survey on the previous page. It populates the page in such as way that the count for how many times an option has been picked appears beside that option. Also, through the use of ngClass it causes the options the user last picked to appear green and bold. I did actually have a bit of trouble with that, but was able to fix it through the use of a data service class to pass data from the survey page to the view page.

## What I learned
I learned how to use angular http to communicate with a back end. I learned how to create a node server as a back end. I learned how to do basic MongoDB operations such as creating a collection, adding to a collection, running queries on collections, counting values in a collection, deleting a collection, etc. I learned how to recieve different types of data with node. I learned how to deal with CORS errors. Finally, I learned how to deal with different get and post requests to node.
